<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Referendum Voting - De Nya Svenskarna</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        h1, h2 {
            margin-bottom: 0.5rem;
        }
        form {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
        }
        .status {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .status.error {
            color: #b00020;
        }
        .status.success {
            color: #006400;
        }
        .results {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
        }
        .results ul {
            padding-left: 1.2rem;
        }
    </style>
</head>
<body>
    <h1>Referendum Voting</h1>

    <!-- 1) CONFIG (you will fill these in) -->
    <script>
        // TODO: REPLACE THESE WITH YOUR VALUES
        const SUPABASE_URL = "https://YOUR-PROJECT-REF.supabase.co";  // from Supabase "Project URL"
        const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";               // from Supabase "anon public"
        const EDGE_FUNCTION_URL = "https://YOUR-PROJECT-REF.functions.supabase.co/cast-vote";
        const REFERENDUM_ID = "YOUR_REFERENDUM_UUID_HERE";
    </script>

    <!-- 2) VOTING FORM -->
    <section>
        <h2>Current Referendum</h2>
        <p id="referendum-title">Loading referendum...</p>

        <form id="vote-form">
            <div>
                <label for="token">Your voting token:</label><br />
                <input type="text" id="token" name="token" required style="width: 100%;" />
            </div>

            <div id="options-container" style="margin-top: 1rem;">
                <!-- Options will be loaded from Supabase -->
                Loading options...
            </div>

            <button type="submit" style="margin-top: 1rem;">Cast my vote</button>

            <div id="vote-status" class="status"></div>
        </form>
    </section>

    <!-- 3) RESULTS -->
    <section class="results">
        <h2>Results</h2>
        <p id="results-status">Loading results...</p>
        <ul id="results-list"></ul>
        <button id="refresh-results">Refresh results</button>
    </section>

    <!-- Supabase JS via CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>

    <script>
        // Init Supabase client (anon)
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 1) Load referendum info + options
        async function loadReferendumAndOptions() {
            const titleEl = document.getElementById("referendum-title");
            const optionsContainer = document.getElementById("options-container");

            try {
                // Load referendum
                const { data: refData, error: refError } = await supabaseClient
                    .from("referendums")
                    .select("title, description")
                    .eq("id", REFERENDUM_ID)
                    .single();

                if (refError || !refData) {
                    console.error(refError);
                    titleEl.textContent = "Unable to load referendum.";
                } else {
                    titleEl.textContent = refData.title;
                }

                // Load options
                const { data: optData, error: optError } = await supabaseClient
                    .from("referendum_options")
                    .select("id, label, sort_order")
                    .eq("referendum_id", REFERENDUM_ID)
                    .order("sort_order", { ascending: true });

                if (optError || !optData || optData.length === 0) {
                    console.error(optError);
                    optionsContainer.textContent = "No options available.";
                    return;
                }

                // Render radio buttons
                optionsContainer.innerHTML = "";
                optData.forEach((opt) => {
                    const div = document.createElement("div");
                    div.style.marginBottom = "0.3rem";

                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = "option";
                    input.value = opt.id;
                    input.id = `option-${opt.id}`;

                    const label = document.createElement("label");
                    label.htmlFor = input.id;
                    label.textContent = opt.label;

                    div.appendChild(input);
                    div.appendChild(label);
                    optionsContainer.appendChild(div);
                });
            } catch (err) {
                console.error(err);
                optionsContainer.textContent = "Error loading options.";
            }
        }

        // 2) Submit vote via Edge Function
        async function submitVote(event) {
            event.preventDefault();
            const statusEl = document.getElementById("vote-status");
            statusEl.className = "status";
            statusEl.textContent = "";

            const tokenInput = document.getElementById("token");
            const token = tokenInput.value.trim();

            const optionInputs = document.querySelectorAll("input[name='option']");
            let selectedOptionId = null;
            optionInputs.forEach((input) => {
                if (input.checked) {
                    selectedOptionId = input.value;
                }
            });

            if (!token) {
                statusEl.textContent = "Please enter your voting token.";
                statusEl.classList.add("error");
                return;
            }

            if (!selectedOptionId) {
                statusEl.textContent = "Please select one of the options.";
                statusEl.classList.add("error");
                return;
            }

            statusEl.textContent = "Submitting your vote...";
            try {
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        token,
                        referendum_id: REFERENDUM_ID,
                        option_id: selectedOptionId,
                    }),
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error("Vote error:", result);
                    statusEl.textContent = result.error || "Error submitting vote.";
                    statusEl.classList.add("error");
                } else {
                    statusEl.textContent = "Your vote has been recorded. Thank you!";
                    statusEl.classList.add("success");
                    // Optionally clear token field so itâ€™s not reused
                    tokenInput.value = "";
                    // Refresh results
                    await loadResults();
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Network error while submitting vote.";
                statusEl.classList.add("error");
            }
        }

        // 3) Load referendum results
        async function loadResults() {
            const statusEl = document.getElementById("results-status");
            const listEl = document.getElementById("results-list");

            statusEl.textContent = "Loading results...";
            listEl.innerHTML = "";

            try {
                const { data, error } = await supabaseClient
                    .from("referendum_results")
                    .select("option_id, label, votes_count")
                    .eq("referendum_id", REFERENDUM_ID);

                if (error) {
                    console.error(error);
                    statusEl.textContent = "Error loading results.";
                    return;
                }

                if (!data || data.length === 0) {
                    statusEl.textContent = "No votes yet.";
                    return;
                }

                statusEl.textContent = "";
                data.forEach((row) => {
                    const li = document.createElement("li");
                    li.textContent = `${row.label}: ${row.votes_count} vote(s)`;
                    listEl.appendChild(li);
                });
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Error loading results.";
            }
        }

        // 4) Hook everything up
        document.getElementById("vote-form").addEventListener("submit", submitVote);
        document
            .getElementById("refresh-results")
            .addEventListener("click", (e) => {
                e.preventDefault();
                loadResults();
            });

        // Initial load
        loadReferendumAndOptions();
        loadResults();
    </script>
       <nav>
 <nav>
     <a href="https://multireligionvalsystem.eu.org/index.html">Home</a>
  <a href="https://referendum.multireligionvalsystem.eu.org/">Tillbaka till startsidan</a>
</nav>
 
</body>
</html>
